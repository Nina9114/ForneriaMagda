{% extends "base.html" %}
{% load static %}
{% block contenido %}
<div class="dashboard-main-container">
    <!-- Sidebar Reutilizable -->
    {% include 'includes/sidebar.html' with active_page='dashboard' %}
    <!-- Main Content -->
    <div class="dashboard-content-wrapper">
        <!-- Header -->
        <header class="dashboard-header">
            <h1 class="dashboard-main-title">Resumen del Día</h1>
            <div class="header-user-info">
                {% if request.user.is_authenticated %}
                    <span class="user-name">{{ request.user.username }}</span>
                    <button type="button" class="user-avatar" id="userMenuButton">
                        {{ request.user.username|slice:":1"|upper }}
                    </button>
                    <div class="user-menu" id="userMenu" aria-hidden="true" hidden>
                        <a href="{% url 'proximamente_feature' 'perfil' %}" class="user-menu-item">Ver perfil</a>
                        <a href="{% url 'logout' %}" class="user-menu-item">Cerrar sesión</a>
                    </div>
                {% else %}
                    <span class="user-name">Invitado</span>
                    <a href="{% url 'login' %}" class="user-avatar">⇢</a>
                {% endif %}
            </div>
        </header>
        <!-- Content -->
        <main class="dashboard-content">
            <!-- ============================================ -->
            <!-- FILA 1: MÉTRICAS PRINCIPALES (4 COLUMNAS)   -->
            <!-- ============================================ -->
            <div class="dashboard-row">
                <!-- Columna 1: Ventas del Día -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card">
                        <h3 class="metric-card-title">Ventas del Día</h3>
                        <p class="metric-card-value">--</p>
                        <p class="metric-card-subtitle">-- transacciones</p>
                    </div>
                </div>

                <!-- Columna 2: Stock Bajo -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card">
                        <h3 class="metric-card-title">Stock Bajo</h3>
                        <p class="metric-card-value">--</p>
                        <p class="metric-card-subtitle">Productos</p>
                    </div>
                </div>

                <!-- Columna 3: Alertas -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card">
                        <h3 class="metric-card-title">Alertas</h3>
                        <p class="metric-card-value">--</p>
                        <p class="metric-card-subtitle">Pendientes</p>
                    </div>
                </div>

                <!-- Columna 4: Top Producto -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card">
                        <h3 class="metric-card-title">Top Producto</h3>
                        <p class="metric-card-value">--</p>
                        <p class="metric-card-subtitle">-- unidades</p>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- FILA 2: ANÁLISIS DE VENCIMIENTOS (4 COLUMNAS) -->
            <!-- ============================================ -->
            <div class="dashboard-row">
                <!-- Columna 1: LISTADOS DE VENCIMIENTOS -->
                <div class="dashboard-col">
                    <!-- Listado 7 días -->
                    <div class="dashboard-metric-card" id="vencimientos-card">
                        <h3 class="metric-card-title">Por vencer (7 días)</h3>
                        <ul id="vencimientos-list" class="metric-list"></ul>
                        <div id="vencimientos-extra" style="display: none;">
                            <ul id="vencimientos-extra-list" class="metric-list"></ul>
                        </div>
                        <button id="vencimientos-toggle" class="metric-card-button" style="display:none;">Ver más</button>
                    </div>

                    <!-- Listado 14 días -->
                    <div class="dashboard-metric-card" id="vencimientos-14-card">
                        <h3 class="metric-card-title">Por vencer (14 días)</h3>
                        <ul id="vencimientos-14-list" class="metric-list"></ul>
                        <div id="vencimientos-14-extra" style="display: none;">
                            <ul id="vencimientos-14-extra-list" class="metric-list"></ul>
                        </div>
                        <button id="vencimientos-14-toggle" class="metric-card-button" style="display:none;">Ver más</button>
                    </div>

                    <!-- Listado 30 días -->
                    <div class="dashboard-metric-card" id="vencimientos-30-card">
                        <h3 class="metric-card-title">Por vencer (30 días)</h3>
                        <ul id="vencimientos-30-list" class="metric-list"></ul>
                        <div id="vencimientos-30-extra" style="display: none;">
                            <ul id="vencimientos-30-extra-list" class="metric-list"></ul>
                        </div>
                        <button id="vencimientos-30-toggle" class="metric-card-button" style="display:none;">Ver más</button>
                    </div>
                </div>

                <!-- Columna 2: GRÁFICOS DE PÉRDIDA POTENCIAL -->
                <div class="dashboard-col">
                    <!-- Gráfico 7 días -->
                    <div class="dashboard-metric-card" id="d3-gauge-container-7-days">
                        <h3 class="metric-card-title">Pérdida potencial (7 días)</h3>
                    </div>

                    <!-- Gráfico 14 días -->
                    <div class="dashboard-metric-card" id="d3-gauge-container-14-days">
                        <h3 class="metric-card-title">Pérdida potencial (14 días)</h3>
                    </div>

                    <!-- Gráfico 30 días -->
                    <div class="dashboard-metric-card" id="d3-gauge-container-30-days">
                        <h3 class="metric-card-title">Pérdida potencial (30 días)</h3>
                    </div>
                </div>

                <!-- Columna 3 y 4: LISTA DE VENTAS DEL DÍA (ocupa 2 espacios debajo de Alertas y Top Producto) -->
                <div class="dashboard-col" style="flex: 2;">
                    <div class="dashboard-metric-card" style="min-height: auto; height: 100%;">
                        <h3 class="metric-card-title">
                            <i class="bi bi-cash-coin" style="color: #D4AF37;"></i>
                            Ventas del Día (Detalle)
                        </h3>
                        <div id="tabla-ventas-dia" style="max-height: 400px; overflow-y: auto; flex: 1;">
                            <p class="text-muted" id="tabla-ventas-dia-loading">Cargando...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- FILA 3: TABLAS DETALLADAS (4 COLUMNAS)      -->
            <!-- ============================================ -->
            <div class="dashboard-row">
                <!-- Columna 1: LISTA DE STOCK BAJO (debajo de Ventas del Día y Stock Bajo) -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card" style="min-height: auto; height: 100%;">
                        <h3 class="metric-card-title">
                            <i class="bi bi-exclamation-triangle-fill" style="color: #ff6b6b;"></i>
                            Productos con Stock Bajo
                        </h3>
                        <div id="tabla-stock-bajo" style="max-height: 400px; overflow-y: auto; flex: 1;">
                            <p class="text-muted" id="tabla-stock-bajo-loading">Cargando...</p>
                        </div>
                    </div>
                </div>

                <!-- Columna 2: LISTA DE MERMA (debajo de Ventas del Día y Stock Bajo) -->
                <div class="dashboard-col">
                    <div class="dashboard-metric-card" style="min-height: auto; height: 100%;">
                        <h3 class="metric-card-title">
                            <i class="bi bi-trash-fill" style="color: #ff6b6b;"></i>
                            Productos en Merma
                        </h3>
                        <div id="tabla-merma" style="max-height: 400px; overflow-y: auto; flex: 1;">
                            <p class="text-muted" id="tabla-merma-loading">Cargando...</p>
                        </div>
                    </div>
                </div>

                <!-- Columna 3 y 4: ESPACIO RESERVADO -->
                <div class="dashboard-col empty-column" style="flex: 2;">
                    <!-- Espacio reservado para futuras funcionalidades -->
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('userMenuButton');
  const menu = document.getElementById('userMenu');
  if (!btn || !menu) return;

  function hide(){
    menu.hidden = true;
    menu.classList.remove('open');
    menu.setAttribute('aria-hidden','true');
  }

  function toggle(){
    const willOpen = menu.hidden;
    menu.hidden = !willOpen;
    menu.classList.toggle('open', willOpen);
    menu.setAttribute('aria-hidden', String(!willOpen));
  }

  btn.addEventListener('click', function(e){ e.stopPropagation(); toggle(); });
  document.addEventListener('click', hide);
  document.addEventListener('keydown', function(e){ if (e.key === 'Escape') hide(); });
});
</script>

<!-- Script para cargar métricas del dashboard -->
<script src="{% static 'js/dashboard_metrics.js' %}?v=3"></script>

<!-- Script para expiraciones -->
<script src="{% static 'js/expiraciones.js' %}?v=2"></script>

<!-- D3.js (necesario para los gráficos) -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Nuestro archivo de gráficos reutilizable -->
<script src="{% static 'js/dashboard_charts.js' %}"></script>

<!-- Inicialización de los gráficos del dashboard -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de 7 días
    initGaugeChart(
        '#d3-gauge-container-7-days',
        "{% url 'api_perdida_potencial' %}",
        10000000,
        'Pérdida Potencial'
    );

    // Gráfico de 14 días
    initGaugeChart(
        '#d3-gauge-container-14-days',
        "{% url 'api_perdida_potencial_14' %}",
        10000000,
        'Pérdida Potencial'
    );

    // Gráfico de 30 días
    initGaugeChart(
        '#d3-gauge-container-30-days',
        "{% url 'api_perdida_potencial_30' %}",
        10000000,
        'Pérdida Potencial'
    );
});
</script>
{% endblock %}