{% extends "base.html" %}
{% load static %}

{% block contenido %}
<!-- ================================================================ -->
<!-- =                                                              = -->
<!-- =              PÁGINA DE GESTIÓN DE MERMA                      = -->
<!-- =                                                              = -->
<!-- ================================================================ -->
<!--
    Esta página muestra todos los productos en estado de merma.
    
    TIPOS DE MERMA:
    - Vencido: Productos que superaron su fecha de caducidad
    - Deteriorado: Productos en mal estado físico
    - Dañado: Productos con daño en empaque o estructura
    
    FUNCIONALIDADES:
    - Ver listado de productos en merma
    - Filtrar por tipo de merma
    - Ver pérdida económica total
-->

<div class="dashboard-main-container">
    <!-- ============================================================ -->
    <!-- SIDEBAR DE NAVEGACIÓN                                        -->
    <!-- ============================================================ -->
    {% include 'includes/sidebar.html' with active_page='merma' %}

    <!-- ============================================================ -->
    <!-- CONTENIDO PRINCIPAL                                          -->
    <!-- ============================================================ -->
    <div class="dashboard-content-wrapper">
        <!-- Header con título -->
        <header class="dashboard-header">
            <h1 class="dashboard-main-title">Gestión de Merma</h1>
        </header>

        <!-- Contenido de la página -->
        <main class="dashboard-content merma-container">
            <!-- ============================================ -->
            <!-- TARJETA DE ESTADÍSTICAS                      -->
            <!-- ============================================ -->
            <div class="merma-stats-card">
                <h3>Resumen de Merma</h3>
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="merma-stats-number">{{ productos.count }}</div>
                        <p class="mb-0">Productos en Merma</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="merma-stats-number">
                            {{ total_unidades }}
                        </div>
                        <p class="mb-0">Total de Unidades</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="merma-stats-number text-danger">
                            ${{ perdida_total|floatformat:"0" }}
                        </div>
                        <p class="mb-0">Pérdida Total</p>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- BARRA DE BÚSQUEDA                            -->
            <!-- ============================================ -->
            <div class="merma-search-container">
                <!-- Barra de búsqueda -->
                <div class="merma-search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" 
                           id="searchInput" 
                           class="merma-search-input" 
                           placeholder="Buscar producto por nombre...">
                    <button id="clearSearch" class="merma-clear-btn" style="display: none;">
                        <i class="bi bi-x-circle-fill"></i>
                    </button>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- TABLA DE PRODUCTOS EN MERMA                  -->
            <!-- ============================================ -->
            <div class="merma-tabla-container">
                <div class="table-responsive">
                    <table class="table merma-tabla">
                        <!-- Encabezado de la tabla -->
                        <thead>
                            <tr>
                                <th class="sortable-header">
                                    <div class="header-content">
                                        <span>PRODUCTO</span>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <span>ESTADO</span>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <span>MOTIVO</span>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <span>FECHA MERMA</span>
                                    </div>
                                </th>
                                <th class="sortable-header" data-sort="cantidad">
                                    <div class="header-content">
                                        <span>CANTIDAD</span>
                                        <div class="sort-icons">
                                            <i class="bi bi-caret-up-fill sort-icon"></i>
                                            <i class="bi bi-caret-down-fill sort-icon"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="sortable-header" data-sort="precio">
                                    <div class="header-content">
                                        <span>PRECIO UNIT.</span>
                                        <div class="sort-icons">
                                            <i class="bi bi-caret-up-fill sort-icon"></i>
                                            <i class="bi bi-caret-down-fill sort-icon"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="sortable-header" data-sort="perdida">
                                    <div class="header-content">
                                        <span>PÉRDIDA TOTAL</span>
                                        <div class="sort-icons">
                                            <i class="bi bi-caret-up-fill sort-icon"></i>
                                            <i class="bi bi-caret-down-fill sort-icon"></i>
                                        </div>
                                    </div>
                                </th>
                                <th class="sortable-header" data-sort="fecha">
                                    <div class="header-content">
                                        <span>FECHA CADUCIDAD</span>
                                        <div class="sort-icons">
                                            <i class="bi bi-caret-up-fill sort-icon"></i>
                                            <i class="bi bi-caret-down-fill sort-icon"></i>
                                        </div>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <span>ACCIONES</span>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        
                        <!-- Cuerpo de la tabla -->
                        <tbody id="mermaTableBody">
                            {% for producto in productos %}
                            <tr class="merma-row" 
                                data-nombre="{{ producto.nombre|lower }}"
                                data-perdida="{{ producto.calcular_perdida }}"
                                data-cantidad="{% if producto.cantidad_merma %}{{ producto.cantidad_merma }}{% else %}{{ producto.cantidad }}{% endif %}"
                                data-precio="{{ producto.precio }}"
                                data-fecha="{% if producto.caducidad %}{{ producto.caducidad|date:'Y-m-d' }}{% else %}9999-12-31{% endif %}">
                                <!-- Columna: Nombre del producto -->
                                <td>
                                    <strong>{{ producto.nombre }}</strong>
                                    <br>
                                    <small class="text-muted col-descripcion">
                                        {{ producto.descripcion|truncatewords:10 }}
                                    </small>
                                </td>
                                
                                <!-- Columna: Estado de merma (con badge de color) -->
                                <td>
                                    {% if producto.estado_merma == 'en_merma' %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-exclamation-triangle"></i> En Merma
                                        </span>
                                    {% elif producto.estado_merma == 'vencido' %}
                                        <span class="badge badge-vencido">
                                            <i class="bi bi-calendar-x"></i> Vencido
                                        </span>
                                    {% elif producto.estado_merma == 'deteriorado' %}
                                        <span class="badge badge-deteriorado">
                                            <i class="bi bi-exclamation-triangle"></i> Deteriorado
                                        </span>
                                    {% elif producto.estado_merma == 'dañado' %}
                                        <span class="badge badge-danado">
                                            <i class="bi bi-box-seam"></i> Dañado
                                        </span>
                                    {% elif producto.estado_merma == 'roto' %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle"></i> Roto
                                        </span>
                                    {% elif producto.estado_merma == 'robado' %}
                                        <span class="badge bg-dark">
                                            <i class="bi bi-shield-exclamation"></i> Robado
                                        </span>
                                    {% elif producto.estado_merma == 'otro' %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-question-circle"></i> Otro
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            {{ producto.get_estado_merma_display|default:producto.estado_merma }}
                                        </span>
                                    {% endif %}
                                </td>
                                
                                <!-- Columna: Motivo de merma -->
                                <td>
                                    {% if producto.motivo_merma %}
                                        <span class="text-muted" title="{{ producto.motivo_merma }}">
                                            {{ producto.motivo_merma|truncatewords:8 }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Columna: Fecha de merma -->
                                <td>
                                    {% if producto.fecha_merma %}
                                        {{ producto.fecha_merma|date:"d/m/Y H:i" }}
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Columna: Cantidad -->
                                <td>
                                    <strong>{% if producto.cantidad_merma and producto.cantidad_merma > 0 %}{{ producto.cantidad_merma }}{% else %}{{ producto.cantidad }}{% endif %}</strong> unidades
                                </td>
                                
                                <!-- Columna: Precio unitario (sin decimales) -->
                                <td>
                                    ${{ producto.precio|floatformat:"0" }}
                                </td>
                                
                                <!-- Columna: Pérdida total (cantidad × precio) -->
                                <td>
                                    <span class="merma-perdida">
                                        ${{ producto.calcular_perdida|floatformat:"0" }}
                                    </span>
                                </td>
                                
                                <!-- Columna: Fecha de caducidad -->
                                <td>
                                    {% if producto.caducidad %}
                                        {{ producto.caducidad|date:"d/m/Y" }}
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Columna: Acciones -->
                                <td>
                                    {% if producto.tiene_historial_merma %}
                                        <form method="post" action="{% url 'eliminar_registro_merma' producto.id %}" style="display: inline;" 
                                              onsubmit="return confirm('¿Eliminar el registro de merma de {{ producto.nombre }}? Esto no afectará el estado actual del producto.');">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                    title="Eliminar registro de merma">
                                                <i class="bi bi-trash"></i> Eliminar Registro
                                            </button>
                                        </form>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <!-- Mensaje cuando no hay productos en merma -->
                            <tr>
                                <td colspan="9" class="merma-vacio">
                                    <i class="bi bi-check-circle"></i>
                                    <p><strong>¡Excelente!</strong></p>
                                    <p>No hay productos en merma</p>
                                    <small>Todos los productos están en buen estado</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<!-- Script para filtros y búsqueda de merma -->
<script src="{% static 'js/merma_filters.js' %}"></script>
{% endblock %}
