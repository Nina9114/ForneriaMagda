{% extends "base.html" %}
{% load static %}

{% block contenido %}
<div class="dashboard-main-container">
    {% include 'includes/sidebar.html' with active_page='facturas_proveedores' %}
    
    <div class="dashboard-content-wrapper">
        <header class="dashboard-header">
            <h1 class="dashboard-main-title">Detalle de Factura: {{ factura.numero_factura }}</h1>
            <div class="header-actions">
                <a href="{% url 'factura_proveedor_editar' factura.id %}" class="btn btn-warning">Editar</a>
                {% if factura.fecha_recepcion %}
                <button type="button" class="btn btn-info" onclick="quitarRecepcion()" title="Quitar fecha de recepción para poder agregar productos">
                    <i class="bi bi-x-circle"></i> Quitar Recepción
                </button>
                {% endif %}
                <a href="{% url 'facturas_proveedores_list' %}" class="btn btn-secondary">Volver</a>
            </div>
        </header>
        
        <main class="dashboard-content">
            <!-- Información de la factura -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>Información de la Factura</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Proveedor:</strong> {{ factura.proveedor.nombre }}</p>
                            <p><strong>Número de Factura:</strong> {{ factura.numero_factura }}</p>
                            <p><strong>Fecha de Factura:</strong> {{ factura.fecha_factura|date:"d/m/Y" }}</p>
                            {% if factura.fecha_vencimiento %}
                            <p><strong>Fecha de Vencimiento:</strong> {{ factura.fecha_vencimiento|date:"d/m/Y" }}</p>
                            {% endif %}
                            {% if factura.fecha_recepcion %}
                            <p><strong>Fecha de Recepción:</strong> {{ factura.fecha_recepcion|date:"d/m/Y" }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <p><strong>Estado de Pago:</strong> 
                                {% if factura.estado_pago == 'pendiente' %}
                                    <span class="badge bg-warning">Pendiente</span>
                                {% elif factura.estado_pago == 'parcial' %}
                                    <span class="badge bg-info">Pago Parcial</span>
                                {% elif factura.estado_pago == 'pagado' %}
                                    <span class="badge bg-success">Pagado</span>
                                {% else %}
                                    <span class="badge bg-secondary">Cancelado</span>
                                {% endif %}
                            </p>
                            <p><strong>Estado de Recepción:</strong> 
                                {% if factura.fecha_recepcion %}
                                    <span class="badge bg-success">Recibida el {{ factura.fecha_recepcion|date:"d/m/Y" }}</span>
                                {% else %}
                                    <span class="badge bg-warning">Pendiente</span>
                                {% endif %}
                            </p>
                            {% if factura.observaciones %}
                            <p><strong>Observaciones:</strong> {{ factura.observaciones }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Agregar producto (solo si no está recibida) -->
            {% if not factura.fecha_recepcion %}
            <div class="card mb-4">
                <div class="card-header">
                    <h3>Agregar Producto</h3>
                </div>
                <div class="card-body">
                    {% if productos %}
                    <form id="formAgregarProducto" class="row g-3">
                        {% csrf_token %}
                        <div class="col-md-4">
                            <label class="form-label">Producto *</label>
                            <select name="producto_id" id="producto_id" class="form-select" required>
                                <option value="">Seleccione un producto</option>
                                {% for producto in productos %}
                                <option value="{{ producto.id }}" data-precio="{{ producto.precio_por_unidad_venta|default:producto.precio }}">
                                    {{ producto.nombre }} - ${{ producto.precio_por_unidad_venta|default:producto.precio|floatformat:0 }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Cantidad *</label>
                            <input type="number" name="cantidad" id="cantidad" class="form-control" min="1" value="1" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Precio Unitario *</label>
                            <input type="number" name="precio_unitario" id="precio_unitario" class="form-control" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Descuento %</label>
                            <input type="number" name="descuento_pct" id="descuento_pct" class="form-control" step="0.01" min="0" max="100" value="0">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fecha Vencimiento (opcional)</label>
                            <input type="date" name="fecha_vencimiento_producto" id="fecha_vencimiento_producto" class="form-control">
                            <small class="form-text text-muted">Si no se especifica, se usará la fecha del producto o fecha factura + 30 días</small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Número de Lote (opcional)</label>
                            <input type="text" name="lote" id="lote" class="form-control" maxlength="50" placeholder="Ej: LOTE-2025-001">
                            <small class="form-text text-muted">Si no se especifica, se generará automáticamente</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">Agregar</button>
                        </div>
                    </form>
                    {% else %}
                    <div class="alert alert-warning">
                        <strong>⚠️ No hay productos disponibles</strong>
                        <p class="mb-0">No hay productos activos en el inventario. Debes crear productos primero desde el módulo de <a href="{% url 'inventario' %}">Inventario</a> (botón "Agregar Producto") antes de poder agregarlos a la factura.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="alert alert-info mb-4">
                <strong>ℹ️ Factura ya recibida</strong>
                <p class="mb-0">Esta factura ya fue recibida el {{ factura.fecha_recepcion|date:"d/m/Y" }}. No se pueden agregar más productos.</p>
            </div>
            {% endif %}
            
            <!-- Detalles de productos -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>Productos en la Factura</h3>
                    {% if not factura.fecha_recepcion %}
                    <button id="btnRecibirFactura" class="btn btn-success">
                        <span>✓</span> Recibir Factura y Actualizar Stock
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if detalles %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="tablaDetalles">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Descuento %</th>
                                    <th>Subtotal</th>
                                    {% if not factura.fecha_recepcion %}
                                    <th>Acciones</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for detalle in detalles %}
                                <tr id="detalle-{{ detalle.id }}">
                                    <td>{{ detalle.productos.nombre }}</td>
                                    <td>{{ detalle.cantidad }}</td>
                                    <td>${{ detalle.precio_unitario|floatformat:0 }}</td>
                                    <td>{{ detalle.descuento_pct|floatformat:2 }}%</td>
                                    <td>${{ detalle.subtotal|floatformat:0 }}</td>
                                    {% if not factura.fecha_recepcion %}
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="eliminarDetalle({{ detalle.id }})">Eliminar</button>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No hay productos registrados en esta factura.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Pagos realizados -->
            {% if pagos %}
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>Pagos Realizados</h3>
                    <a href="{% url 'pago_proveedor_crear_factura' factura.id %}" class="btn btn-success btn-sm">
                        <span>➕</span> Registrar Pago
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Monto</th>
                                    <th>Método</th>
                                    <th>Comprobante</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pago in pagos %}
                                <tr>
                                    <td>{{ pago.fecha_pago|date:"d/m/Y" }}</td>
                                    <td><strong>${{ pago.monto|floatformat:0 }}</strong></td>
                                    <td>{{ pago.get_metodo_pago_display|default:pago.metodo_pago }}</td>
                                    <td>{{ pago.numero_comprobante|default:"-" }}</td>
                                    <td>
                                        <a href="{% url 'pago_proveedor_eliminar' pago.id %}" class="btn btn-sm btn-danger">Eliminar</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card mb-4">
                <div class="card-body text-center">
                    <p class="text-muted">No hay pagos registrados para esta factura.</p>
                    <a href="{% url 'pago_proveedor_crear_factura' factura.id %}" class="btn btn-success">
                        <span>➕</span> Registrar Primer Pago
                    </a>
                </div>
            </div>
            {% endif %}
            
            <!-- Totales -->
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 offset-md-6">
                            <table class="table">
                                <tr>
                                    <td><strong>Subtotal sin IVA (Neto):</strong></td>
                                    <td class="text-end">${{ factura.subtotal_sin_iva|floatformat:0 }}</td>
                                </tr>
                                <tr>
                                    <td><strong>IVA (19%):</strong></td>
                                    <td class="text-end">${{ factura.total_iva|floatformat:0 }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Descuento:</strong></td>
                                    <td class="text-end">-${{ factura.descuento|floatformat:0 }}</td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>Total Factura:</strong></td>
                                    <td class="text-end"><strong>${{ factura.total_con_iva|floatformat:0 }}</strong></td>
                                </tr>
                                {% if pagos %}
                                <tr>
                                    <td><strong>Total Pagado:</strong></td>
                                    <td class="text-end text-success">${{ total_pagado|floatformat:0 }}</td>
                                </tr>
                                <tr class="{% if saldo_pendiente > 0 %}table-warning{% else %}table-success{% endif %}">
                                    <td><strong>Saldo Pendiente:</strong></td>
                                    <td class="text-end"><strong>${{ saldo_pendiente|floatformat:0 }}</strong></td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock contenido %}

{% block javascripts %}
<script>
const facturaId = {{ factura.id }};

// Cargar precio cuando se selecciona un producto
document.getElementById('producto_id')?.addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    const precio = option.getAttribute('data-precio');
    if (precio) {
        document.getElementById('precio_unitario').value = precio;
    }
});

// Agregar producto a la factura
document.getElementById('formAgregarProducto')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    formData.append('factura_id', facturaId);
    
    try {
        const response = await fetch(`/api/factura/${facturaId}/agregar-producto/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.mensaje);
            location.reload(); // Recargar para ver los cambios
        } else {
            alert('Error: ' + data.mensaje);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al agregar producto');
    }
});

// Eliminar detalle
async function eliminarDetalle(detalleId) {
    if (!confirm('¿Está seguro que desea eliminar este producto de la factura?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/detalle-factura/${detalleId}/eliminar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.mensaje);
            location.reload();
        } else {
            alert('Error: ' + data.mensaje);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar producto');
    }
}

// Recibir factura y actualizar stock
document.getElementById('btnRecibirFactura')?.addEventListener('click', async function() {
    if (!confirm('¿Está seguro que desea recibir esta factura? Esto actualizará el stock de todos los productos.')) {
        return;
    }
    
    this.disabled = true;
    this.textContent = 'Procesando...';
    
    try {
        const response = await fetch(`/api/factura/${facturaId}/recibir/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.mensaje);
            location.reload();
        } else {
            alert('Error: ' + data.mensaje);
            this.disabled = false;
            this.innerHTML = '<span>✓</span> Recibir Factura y Actualizar Stock';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al recibir factura');
        this.disabled = false;
        this.innerHTML = '<span>✓</span> Recibir Factura y Actualizar Stock';
    }
});

// Quitar recepción de factura
async function quitarRecepcion() {
    if (!confirm('⚠️ ADVERTENCIA: ¿Está seguro que desea quitar la fecha de recepción de esta factura?\n\n' +
               'Esto REVERTIRÁ el stock de todos los productos de esta factura.\n' +
               'Si ya vendiste algunos productos, el stock puede quedar incorrecto.\n\n' +
               '¿Desea continuar?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/factura/${facturaId}/quitar-recepcion/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.mensaje);
            location.reload();
        } else {
            alert('Error: ' + data.mensaje);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al quitar recepción. Intenta editar la factura manualmente.');
    }
}
</script>
{% endblock %}

