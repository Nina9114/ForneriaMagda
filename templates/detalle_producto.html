{% extends "base.html" %}
{% load static %}

{% block body_class %}dark-gold-theme{% endblock %}

{% block contenido %}
<div class="dashboard-main-container">
    <!-- Sidebar Reutilizable -->
    {% include 'includes/sidebar.html' with active_page='inventario' %}

    <div class="dashboard-content-wrapper">
        <div class="inventory-container dark-gold-theme">
            <!-- Encabezado -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="margin: 0;">Detalle del Producto</h2>
                    <p class="text-muted" style="margin: 5px 0 0 0;">{{ producto.nombre }}</p>
                </div>
                <div>
                    <a href="{% url 'inventario' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver al Inventario
                    </a>
                    <a href="{% url 'editar_producto' producto.id %}" class="btn btn-primary">
                        <i class="bi bi-pencil"></i> Editar Producto
                    </a>
                </div>
            </div>

            {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                <li class="{{ message.tags }}">{{ message }}</li>
                {% endfor %}
            </ul>
            {% endif %}

            <!-- Información Principal -->
            <div class="row mb-4">
                <!-- Información Básica -->
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información Básica</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Nombre:</strong></td>
                                    <td>{{ producto.nombre }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Descripción:</strong></td>
                                    <td>{{ producto.descripcion|default:"—" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Marca:</strong></td>
                                    <td>{{ producto.marca|default:"—" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Tipo:</strong></td>
                                    <td>{{ producto.tipo|default:"—" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Categoría:</strong></td>
                                    <td>{{ producto.categorias.nombre|default:"—" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Formato:</strong></td>
                                    <td>{{ producto.formato|default:"—" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Presentación:</strong></td>
                                    <td>{{ producto.presentacion|default:"—" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Precio:</strong></td>
                                    <td><strong class="text-success">${{ producto.precio|floatformat:"0" }}</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Stock y Estado -->
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="bi bi-box-seam"></i> Stock y Estado</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Cantidad en Stock:</strong></td>
                                    <td>
                                        <span class="badge {% if cantidad_desde_lotes <= producto.stock_minimo|default:5 %}bg-danger{% elif cantidad_desde_lotes >= producto.stock_maximo|default:100 %}bg-success{% else %}bg-primary{% endif %} fs-6">
                                            {% if producto.unidad_stock == 'unidad' %}
                                                {{ cantidad_desde_lotes|floatformat:"0" }} {{ producto.get_unidad_stock_display }}
                                            {% else %}
                                                {{ cantidad_desde_lotes|floatformat:"3" }} {{ producto.get_unidad_stock_display }}
                                            {% endif %}
                                        </span>
                                        {% if lotes %}
                                            <small class="text-muted d-block mt-1">
                                                (Calculado desde {{ lotes|length }} lote{{ lotes|length|pluralize }})
                                            </small>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Stock Mínimo:</strong></td>
                                    <td>{{ producto.stock_minimo|default:"No definido" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Stock Máximo:</strong></td>
                                    <td>{{ producto.stock_maximo|default:"No definido" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Estado:</strong></td>
                                    <td>
                                        {% if producto.estado_merma == 'activo' %}
                                            <span class="badge bg-success">Activo</span>
                                        {% elif producto.estado_merma == 'inactivo' %}
                                            <span class="badge bg-secondary">Inactivo</span>
                                        {% elif producto.estado_merma == 'en_merma' %}
                                            <span class="badge bg-danger">En Merma</span>
                                        {% elif producto.estado_merma == 'vencido' %}
                                            <span class="badge bg-danger">Vencido</span>
                                        {% elif producto.estado_merma == 'deteriorado' %}
                                            <span class="badge bg-warning text-dark">Deteriorado</span>
                                        {% elif producto.estado_merma == 'dañado' %}
                                            <span class="badge bg-secondary">Dañado</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ producto.estado_merma }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Fecha Elaboración:</strong></td>
                                    <td>{{ producto.elaboracion|date:"d/m/Y"|default:"—" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Fecha Caducidad:</strong></td>
                                    <td>
                                        {% if producto.caducidad %}
                                            {{ producto.caducidad|date:"d/m/Y" }}
                                            {% if producto.esta_vencido %}
                                                <span class="badge bg-danger ms-2">Vencido</span>
                                            {% else %}
                                                <span class="badge bg-info ms-2">{{ producto.dias_hasta_vencer }} días</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">—</span>
                                            {% if producto.estado_merma == 'en_merma' %}
                                                <span class="badge bg-danger ms-2">En Merma</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if producto.tiene_historial_merma %}
                                <tr>
                                    <td colspan="2" class="bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>Historial de Merma:</strong><br>
                                                <small class="text-muted">
                                                    {% if producto.cantidad_merma and producto.cantidad_merma > 0 %}
                                                        <strong>Cantidad perdida:</strong> 
                                                        {% if producto.unidad_stock == 'unidad' %}
                                                            {{ producto.cantidad_merma|floatformat:"0" }} {{ producto.get_unidad_stock_display }}
                                                        {% else %}
                                                            {{ producto.cantidad_merma|floatformat:"3" }} {{ producto.get_unidad_stock_display }}
                                                        {% endif %}
                                                        <br>
                                                    {% endif %}
                                                    <strong>Motivo:</strong> {{ producto.motivo_merma|default:"No especificado" }}<br>
                                                    <strong>Fecha:</strong> {{ producto.fecha_merma|date:"d/m/Y H:i"|default:"N/A" }}
                                                </small>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información Nutricional -->
            {% if nutricional %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-heart-pulse"></i> Información Nutricional</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Calorías:</strong> {{ nutricional.calorias|default:"—" }} kcal
                                </div>
                                <div class="col-md-3">
                                    <strong>Proteínas:</strong> {{ nutricional.proteinas|default:"—" }} g
                                </div>
                                <div class="col-md-3">
                                    <strong>Grasas:</strong> {{ nutricional.grasas|default:"—" }} g
                                </div>
                                <div class="col-md-3">
                                    <strong>Carbohidratos:</strong> {{ nutricional.carbohidratos|default:"—" }} g
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-3">
                                    <strong>Azúcares:</strong> {{ nutricional.azucares|default:"—" }} g
                                </div>
                                <div class="col-md-3">
                                    <strong>Sodio:</strong> {{ nutricional.sodio|default:"—" }} mg
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Lotes del Producto -->
            {% if lotes %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-boxes"></i> Lotes del Producto 
                                <small class="text-white-50 ms-2">({{ lotes|length }} lote{{ lotes|length|pluralize }})</small>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>ID Lote</th>
                                            <th>Número de Lote</th>
                                            <th>Cantidad</th>
                                            <th>Cantidad Inicial</th>
                                            <th>Fecha Elaboración</th>
                                            <th>Fecha Caducidad</th>
                                            <th>Días hasta Vencer</th>
                                            <th>Origen</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for lote in lotes %}
                                        <tr>
                                            <td>{{ lote.id }}</td>
                                            <td>{{ lote.numero_lote|default:"—" }}</td>
                                            <td>
                                                <strong>{{ lote.cantidad }}</strong>
                                                <small class="text-muted">
                                                    ({{ lote.cantidad_inicial }} inicial)
                                                </small>
                                            </td>
                                            <td>{{ lote.cantidad_inicial }}</td>
                                            <td>{{ lote.fecha_elaboracion|date:"d/m/Y"|default:"—" }}</td>
                                            <td>{{ lote.fecha_caducidad|date:"d/m/Y" }}</td>
                                            <td>
                                                {% with dias=lote.dias_hasta_vencer %}
                                                    {% if dias is not None %}
                                                        {% if dias < 0 %}
                                                            <span class="badge bg-danger">Vencido ({{ dias|add:"0"|slice:"1:" }} días)</span>
                                                        {% elif dias <= 3 %}
                                                            <span class="badge bg-danger">{{ dias }} días</span>
                                                        {% elif dias <= 7 %}
                                                            <span class="badge bg-warning text-dark">{{ dias }} días</span>
                                                        {% else %}
                                                            <span class="badge bg-success">{{ dias }} días</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">—</span>
                                                    {% endif %}
                                                {% endwith %}
                                            </td>
                                            <td>
                                                {% if lote.origen == 'produccion_propia' %}
                                                    <span class="badge bg-primary">Producción Propia</span>
                                                {% elif lote.origen == 'compra' %}
                                                    <span class="badge bg-info">Compra</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Ajuste Manual</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if lote.estado == 'activo' %}
                                                    <span class="badge bg-success">Activo</span>
                                                {% elif lote.estado == 'agotado' %}
                                                    <span class="badge bg-secondary">Agotado</span>
                                                {% elif lote.estado == 'vencido' %}
                                                    <span class="badge bg-danger">Vencido</span>
                                                {% elif lote.estado == 'en_merma' %}
                                                    <span class="badge bg-danger">En Merma</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ lote.estado }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <a href="{% url 'produccion_list' %}?producto_id={{ producto.id }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-boxes"></i> Ver todos los lotes
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Este producto no tiene lotes registrados. 
                        <a href="{% url 'produccion_crear' %}?producto_id={{ producto.id }}" class="alert-link">
                            Crear primer lote
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Estadísticas -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-primary">{{ entradas_totales }}</h3>
                            <p class="text-muted mb-0">Entradas Totales</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-danger">{{ salidas_totales }}</h3>
                            <p class="text-muted mb-0">Salidas Totales</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-success">{{ total_ventas_cantidad }}</h3>
                            <p class="text-muted mb-0">Unidades Vendidas</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertas Activas -->
            {% if alertas %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Alertas Activas</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group">
                                {% for alerta in alertas %}
                                <li class="list-group-item">
                                    <span class="badge bg-{% if alerta.tipo_alerta == 'roja' %}danger{% elif alerta.tipo_alerta == 'amarilla' %}warning text-dark{% else %}success{% endif %}">
                                        {{ alerta.get_tipo_alerta_display }}
                                    </span>
                                    {{ alerta.mensaje }}
                                    <small class="text-muted ms-2">({{ alerta.fecha_generada|date:"d/m/Y H:i" }})</small>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Movimientos Recientes -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-arrow-left-right"></i> Movimientos Recientes</h5>
                            <small class="text-light">
                                Mostrando últimos 10 de {{ total_movimientos }} movimiento(s) total(es)
                                {% if total_movimientos > 10 %}
                                    <br><small>({{ total_entradas_count }} entradas, {{ total_salidas_count }} salidas)</small>
                                {% endif %}
                            </small>
                        </div>
                        <div class="card-body">
                            {% if movimientos %}
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Tipo</th>
                                            <th>Cantidad</th>
                                            <th>Origen</th>
                                            <th>Referencia</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for movimiento in movimientos %}
                                        <tr>
                                            <td>{{ movimiento.fecha|date:"d/m/Y H:i" }}</td>
                                            <td>
                                                <span class="badge {% if movimiento.tipo_movimiento == 'entrada' %}bg-success{% else %}bg-danger{% endif %}">
                                                    {{ movimiento.get_tipo_movimiento_display }}
                                                </span>
                                            </td>
                                            <td><strong>{{ movimiento.cantidad }}</strong></td>
                                            <td>{{ movimiento.origen|default:"—" }}</td>
                                            <td>
                                                {% if movimiento.tipo_referencia %}
                                                    <small class="text-muted">{{ movimiento.tipo_referencia }}</small>
                                                    {% if movimiento.referencia_id %}
                                                        <small class="text-muted">#{{ movimiento.referencia_id }}</small>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">—</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    {% if total_movimientos > 10 %}
                                    <tfoot>
                                        <tr class="bg-light">
                                            <td colspan="2"><strong>Suma de estos 10 movimientos:</strong></td>
                                            <td>
                                                <strong>Entradas:</strong> {{ suma_entradas_recientes }} | 
                                                <strong>Salidas:</strong> {{ suma_salidas_recientes }}
                                            </td>
                                            <td colspan="2">
                                                <small class="text-muted">
                                                    <strong>Total histórico:</strong> Entradas: {{ entradas_totales }} | Salidas: {{ salidas_totales }}
                                                </small>
                                            </td>
                                        </tr>
                                    </tfoot>
                                    {% endif %}
                                </table>
                            </div>
                            {% else %}
                            <p class="text-muted text-center">No hay movimientos registrados para este producto.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ventas Recientes -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-cart-check"></i> Ventas Recientes</h5>
                        </div>
                        <div class="card-body">
                            {% if ventas_recientes %}
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Cantidad</th>
                                            <th>Precio Unitario</th>
                                            <th>Subtotal</th>
                                            <th>Cliente</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for detalle in ventas_recientes %}
                                        <tr>
                                            <td>{{ detalle.ventas.fecha|date:"d/m/Y H:i" }}</td>
                                            <td>{{ detalle.cantidad }}</td>
                                            <td>${{ detalle.precio_unitario|floatformat:"0" }}</td>
                                            <td><strong>${{ detalle.subtotal|floatformat:"0" }}</strong></td>
                                            <td>{{ detalle.ventas.clientes.nombre|default:"—" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <p class="text-muted text-center">No hay ventas registradas para este producto.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

